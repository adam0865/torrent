<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TorrentChain Pro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { background: radial-gradient(circle at top, #020617, #000); }
    .glass { background: rgba(15,23,42,.85); backdrop-filter: blur(12px); }
  </style>
</head>

<body class="text-slate-100 min-h-screen">

<header class="glass border-b border-slate-700 px-10 py-5 flex justify-between">
  <div>
    <h1 class="text-2xl font-bold">TorrentChain</h1>
    <p class="text-xs text-slate-400">P2P Preservation Network</p>
  </div>
  <span class="text-sm text-green-400">● API Connected</span>
</header>

<main class="max-w-7xl mx-auto p-8 space-y-8">

<!-- GRID -->
<section class="grid grid-cols-1 md:grid-cols-3 gap-6">

<!-- UPLOAD -->
<div class="glass p-6 rounded-2xl border border-slate-700">
  <h2 class="font-semibold mb-4 flex gap-2">
    <i data-lucide="upload"></i> Upload File
  </h2>
  <input id="uploadFileInput" type="file"
         class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm"/>
  <button onclick="uploadFile()"
          class="w-full mt-4 bg-indigo-600 hover:bg-indigo-500 rounded py-2">
    Upload & Register
  </button>
  <div id="uploadResult" class="mt-3 text-xs"></div>
</div>

<!-- VERIFY -->
<div class="glass p-6 rounded-2xl border border-slate-700">
  <h2 class="font-semibold mb-4 flex gap-2">
    <i data-lucide="shield-check"></i> Verify Hash
  </h2>
  <input id="verifyInput" placeholder="SHA-256 Hash"
         class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm"/>
  <button onclick="verifyHash()"
          class="w-full mt-4 bg-emerald-600 hover:bg-emerald-500 rounded py-2">
    Verify
  </button>
  <div id="verifyResult" class="mt-3 text-xs"></div>
</div>

<!-- NODE REGISTER -->
<div class="glass p-6 rounded-2xl border border-slate-700">
  <h2 class="font-semibold mb-4 flex gap-2">
    <i data-lucide="server"></i> Register Node
  </h2>
  <input id="nodeAddressInput" placeholder="Node ID"
         class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm"/>
  <button onclick="registerNode()"
          class="w-full mt-4 bg-amber-600 hover:bg-amber-500 rounded py-2">
    Register
  </button>
  <div id="nodeResult" class="mt-3 text-xs"></div>
</div>

</section>

<!-- NODE MONITOR -->
<section class="glass p-6 rounded-2xl border border-slate-700">
  <div class="flex justify-between mb-4">
    <h2 class="font-semibold flex gap-2">
      <i data-lucide="activity"></i> Node Monitor
    </h2>
    <button onclick="loadNodes()"
            class="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded text-sm">
      Refresh
    </button>
  </div>
  <pre id="nodeBox"
       class="text-xs bg-slate-900 p-3 rounded border border-slate-700">
Loading nodes...
  </pre>
</section>

<!-- LEDGER -->
<section class="glass p-6 rounded-2xl border border-slate-700">
  <div class="flex justify-between mb-4">
    <h2 class="font-semibold flex gap-2">
      <i data-lucide="database"></i> Ledger Summary
    </h2>
    <button onclick="loadSummary()"
            class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-sm">
      Refresh
    </button>
  </div>
  <div id="summaryBox" class="space-y-3 text-sm">Loading...</div>
</section>

</main>

<footer class="text-center text-xs text-slate-500 py-6">
  © 2025 TorrentChain – Academic P2P System
</footer>

<script>
const API = "http://127.0.0.1:8000"

/* ================= UPLOAD ================= */
function uploadFile() {
  const input = document.getElementById("uploadFileInput")
  if (!input.files.length) return alert("Pilih file")

  const form = new FormData()
  form.append("file", input.files[0])

  fetch(`${API}/upload`, { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      document.getElementById("uploadResult").innerHTML =
        `✅ Uploaded<br><b>${data.filename}</b><br>${data.hash}`
      loadSummary()
    })
}

/* ================= LEDGER ================= */
function loadSummary() {
  fetch(`${API}/summary`)
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById("summaryBox")
      box.innerHTML = ""

      if (!data.length) {
        box.innerHTML = "<i>No files registered</i>"
        return
      }

      data.forEach(f => {
        box.innerHTML += `
          <div class="p-3 bg-slate-900 border border-slate-700 rounded">
            <b>${f.filename}</b><br>
            <span class="text-xs break-all">${f.hash}</span><br>
            <span class="text-xs">Chunks: ${f.chunks}</span><br>
            <a href="${API}/download/${f.hash}"
               download
               class="inline-block mt-2 text-cyan-400 hover:underline">
               ⬇ Download
            </a>
          </div>
        `
      })
    })
    .catch(() => {
      document.getElementById("summaryBox").innerHTML =
        "<span class='text-red-400'>Failed to load ledger</span>"
    })
}

/* ================= NODE REGISTER ================= */
function registerNode() {
  const nodeId = document.getElementById("nodeAddressInput").value
  if (!nodeId) return alert("Masukkan Node ID")

  fetch(`${API}/register-node`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: nodeId,
      time: new Date().toISOString()
    })
  })
    .then(res => res.json())
    .then(() => {
      document.getElementById("nodeResult").innerText = "✅ Node registered"
      loadNodes()
    })
}

/* ================= NODE MONITOR ================= */
function loadNodes() {
  fetch(`${API}/nodes`)
    .then(res => res.json())
    .then(nodes => {
      const box = document.getElementById("nodeBox")
      if (!nodes.length) {
        box.textContent = "No nodes registered"
        return
      }
      box.textContent = JSON.stringify(nodes, null, 2)
    })
    .catch(() => {
      document.getElementById("nodeBox").textContent =
        "Failed to load nodes"
    })
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons()
  loadSummary()
  loadNodes()
})
</script>


</body>
</html>
